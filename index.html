√∑—í<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valentine Show</title>
  <style>
    :root{
      --bg-a:#120711;
      --bg-b:#3a0f2a;
      --bg-c:#93273e;
      --card:#1e1022cc;
      --card-stroke:#ffffff2e;
      --text:#ffeef2;
      --muted:#ffd7decc;
      --primary:#ff4f7b;
      --primary-2:#ff875f;
      --accent:#ffd074;
      --shadow:0 26px 90px rgba(6,1,8,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      min-height:100svh;
      overflow-x:hidden;
      color:var(--text);
      font-family:"Trebuchet MS","Segoe UI",sans-serif;
      background:
        radial-gradient(1000px 680px at -8% -14%, rgba(255,129,148,.22), transparent 58%),
        radial-gradient(820px 620px at 110% 0%, rgba(255,187,128,.2), transparent 62%),
        radial-gradient(980px 760px at 50% 120%, rgba(255,71,120,.23), transparent 62%),
        linear-gradient(145deg, var(--bg-a), var(--bg-b) 46%, var(--bg-c));
    }

    body::before,
    body::after{
      content:"";
      position:fixed;
      pointer-events:none;
      z-index:0;
    }

    body::before{
      inset:0;
      opacity:.1;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cpath d='M0 110h220M110 0v220' stroke='%23fff' stroke-opacity='.45' stroke-width='.5'/%3E%3C/svg%3E");
      background-size:220px 220px;
      mix-blend-mode:soft-light;
    }

    body::after{
      width:56vmax;
      aspect-ratio:1/1;
      right:-18vmax;
      top:-24vmax;
      border-radius:50%;
      background:radial-gradient(circle at center, rgba(255,179,151,.22), rgba(255,179,151,0) 67%);
      filter:blur(8px);
      animation:blobDrift 16s ease-in-out infinite alternate;
    }

    @keyframes blobDrift{
      from{ transform:translate3d(0,0,0) scale(1); }
      to{ transform:translate3d(-20px,34px,0) scale(1.12); }
    }

    #fx{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      z-index:12;
      pointer-events:none;
    }

    .page{
      position:relative;
      z-index:2;
      min-height:100svh;
      display:grid;
      place-items:center;
      padding:clamp(12px, 2.8vw, 34px);
    }

    .card{
      width:min(1040px, 100%);
      display:grid;
      grid-template-columns:1.16fr .84fr;
      gap:clamp(16px, 2.3vw, 28px);
      border-radius:30px;
      border:1px solid var(--card-stroke);
      background:
        radial-gradient(680px 380px at 10% 6%, rgba(255,118,154,.11), transparent 70%),
        radial-gradient(580px 360px at 100% 100%, rgba(255,189,122,.12), transparent 72%),
        var(--card);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:clamp(16px, 2.4vw, 32px);
      transform-style:preserve-3d;
      transition:transform .22s ease, box-shadow .22s ease;
      animation:cardIn .85s cubic-bezier(.16,1,.3,1);
      isolation:isolate;
    }

    @keyframes cardIn{
      from{ opacity:0; transform:translateY(22px) scale(.98); }
      to{ opacity:1; transform:translateY(0) scale(1); }
    }

    .panel{
      position:relative;
      z-index:2;
      min-width:0;
    }

    .eyebrow{
      margin:0;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#fff2f4d6;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #ffffff2a;
      background:#ffffff14;
    }

    h1{
      margin:14px 0 0;
      font-family:"Palatino Linotype","Book Antiqua","Times New Roman",serif;
      font-size:clamp(34px, 5.2vw, 60px);
      line-height:1;
      letter-spacing:-.02em;
      text-wrap:balance;
    }

    h1 span{
      color:#ffd294;
      text-shadow:0 6px 28px rgba(255,209,122,.28);
    }

    .lead{
      margin:14px 0 0;
      max-width:58ch;
      color:var(--muted);
      line-height:1.62;
      font-size:clamp(14px, 1.7vw, 17px);
    }

    .controls{
      margin-top:18px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }

    .btn{
      appearance:none;
      border:none;
      border-radius:14px;
      min-height:48px;
      padding:12px 14px;
      cursor:pointer;
      color:#fff5f7;
      font-weight:800;
      letter-spacing:.02em;
      font-size:14px;
      position:relative;
      overflow:hidden;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      transition:transform .16s ease, filter .16s ease, box-shadow .16s ease;
    }

    .btn::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(115deg, transparent 28%, rgba(255,255,255,.62) 50%, transparent 74%);
      transform:translateX(-130%);
      transition:transform .45s ease;
      pointer-events:none;
    }

    .btn:hover::before{ transform:translateX(130%); }
    .btn:active{ transform:scale(.98); }
    .btn:focus-visible{
      outline:2px solid #ffd08f;
      outline-offset:2px;
    }

    .btn-main{
      background:linear-gradient(135deg, var(--primary), #ff3f6f 46%, #ff8d62);
      box-shadow:0 14px 38px rgba(255,75,122,.36);
    }

    .btn-alt{
      background:linear-gradient(135deg, #ff9358, #ff6e4b 48%, #ff4975);
      box-shadow:0 14px 38px rgba(255,130,90,.34);
    }

    .btn-ghost{
      border:1px solid #ffffff30;
      color:#ffeff2;
      background:#ffffff14;
      box-shadow:0 10px 24px rgba(0,0,0,.2);
    }

    .btn:hover{
      filter:brightness(1.07);
      transform:translateY(-2px);
    }

    .legend{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid #ffffff24;
      background:#ffffff0e;
      color:#ffe2e7d4;
    }

    .legend p{
      margin:0;
      font-size:13.5px;
      line-height:1.48;
    }

    .legend p + p{
      margin-top:6px;
      padding-top:6px;
      border-top:1px dashed #ffffff24;
    }

    .legend strong{ color:#fff8d7; }

    .letter{
      margin-top:14px;
      border-radius:18px;
      border:1px solid #ffffff2b;
      min-height:146px;
      padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      transform:translateY(8px);
      opacity:.66;
      transition:opacity .35s ease, transform .35s ease, box-shadow .35s ease;
    }

    .letter.show{
      opacity:1;
      transform:translateY(0);
      box-shadow:0 18px 40px rgba(255,91,128,.18);
    }

    .typing{
      white-space:pre-wrap;
      line-height:1.58;
      font-size:16px;
      color:#fff4f5;
    }

    .cursor{
      display:inline-block;
      width:10px;
      border-bottom:2px solid #fff5f6;
      margin-left:2px;
      transform:translateY(-1px);
      animation:blink 1s steps(1) infinite;
    }

    @keyframes blink{
      50%{ opacity:0; }
    }

    .panel-visual{
      display:grid;
      align-content:center;
      justify-items:center;
      gap:14px;
    }

    .stage{
      position:relative;
      width:min(360px, 86%);
      aspect-ratio:1/1;
      display:grid;
      place-items:center;
      filter:drop-shadow(0 28px 46px rgba(0,0,0,.36));
      transition:transform .2s ease;
    }

    .glow{
      position:absolute;
      inset:14%;
      border-radius:50%;
      background:
        radial-gradient(circle at center, rgba(255,198,146,.62), rgba(255,198,146,0) 60%);
      filter:blur(12px);
      animation:glowPulse 2.6s ease-in-out infinite;
      pointer-events:none;
    }

    @keyframes glowPulse{
      0%,100%{ opacity:.72; transform:scale(.95); }
      50%{ opacity:1; transform:scale(1.08); }
    }

    .ring{
      position:absolute;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.35);
      pointer-events:none;
    }

    .ring-a{
      width:88%;
      height:88%;
      border-style:dashed;
      animation:spinA 12s linear infinite;
    }

    .ring-b{
      width:64%;
      height:64%;
      border-color:rgba(255,205,118,.62);
      animation:spinB 8s linear infinite reverse;
    }

    @keyframes spinA{ to{ transform:rotate(360deg); } }
    @keyframes spinB{ to{ transform:rotate(360deg); } }

    .heart{
      width:48%;
      height:48%;
      position:relative;
      transform:rotate(-45deg);
      border-radius:18px;
      background:radial-gradient(circle at 34% 30%, #ffe8ef, #ff4c78 38%, #c5254f 76%);
      box-shadow:0 0 0 1px rgba(255,255,255,.46) inset;
      animation:heartBeat 1.25s ease-in-out infinite;
    }

    .heart::before,
    .heart::after{
      content:"";
      position:absolute;
      width:100%;
      height:100%;
      border-radius:50%;
      background:inherit;
    }

    .heart::before{ top:-50%; left:0; }
    .heart::after{ left:50%; top:0; }

    @keyframes heartBeat{
      0%,100%{ transform:rotate(-45deg) scale(1); }
      50%{ transform:rotate(-45deg) scale(1.08); }
    }

    .heart.boom{
      animation:heartBoom .72s cubic-bezier(.22,1,.36,1);
    }

    @keyframes heartBoom{
      0%{ transform:rotate(-45deg) scale(1); }
      45%{ transform:rotate(-45deg) scale(1.24); }
      100%{ transform:rotate(-45deg) scale(1); }
    }

    .stage.wow{
      animation:stageFlash .75s ease;
    }

    @keyframes stageFlash{
      0%{ transform:scale(1); filter:drop-shadow(0 28px 46px rgba(0,0,0,.36)); }
      34%{ transform:scale(1.06); filter:drop-shadow(0 36px 64px rgba(255,118,156,.48)); }
      100%{ transform:scale(1); filter:drop-shadow(0 28px 46px rgba(0,0,0,.36)); }
    }

    .from{
      margin:0;
      color:#ffe5ead6;
      border:1px solid #ffffff28;
      background:#ffffff14;
      padding:8px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%) translateY(12px);
      z-index:20;
      min-width:190px;
      max-width:min(90vw, 480px);
      border-radius:12px;
      border:1px solid #ffffff32;
      background:#1a101fe0;
      color:#fff4f7;
      padding:10px 14px;
      text-align:center;
      font-weight:700;
      opacity:0;
      pointer-events:none;
      transition:opacity .26s ease, transform .26s ease;
      box-shadow:0 12px 28px rgba(0,0,0,.36);
    }

    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    @media (max-width: 940px){
      .card{
        grid-template-columns:1fr;
      }
      .panel-visual{
        order:-1;
      }
      .stage{
        width:min(310px, 76vw);
      }
      .controls{
        grid-template-columns:1fr 1fr;
      }
      .btn-ghost{
        grid-column:1 / -1;
      }
    }

    @media (max-width: 640px){
      .page{
        align-items:start;
      }
      .card{
        border-radius:22px;
        padding:14px;
      }
      h1{
        font-size:clamp(31px, 11vw, 44px);
      }
      .controls{
        grid-template-columns:1fr;
      }
      .btn-ghost{
        grid-column:auto;
      }
      .legend{
        font-size:13px;
      }
      .letter{
        min-height:182px;
      }
      .typing{
        font-size:15px;
      }
      .stage{
        width:min(270px, 74vw);
      }
      .from{
        width:100%;
        text-align:center;
      }
    }

    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{
        animation-duration:.01ms !important;
        animation-iteration-count:1 !important;
        transition-duration:.01ms !important;
      }
    }
  </style>
</head>
<body>
  <canvas id="fx" aria-hidden="true"></canvas>

  <main class="page">
    <section class="card" id="card">
      <div class="panel panel-main">
        <p class="eyebrow">Valentine Show</p>
        <h1>–î–ª—è —Ç–µ–±—è, <span id="toName">...</span> üíå</h1>
        <p class="lead">
          –ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –¢—ã —Å–∞–º(–∞) —É–ø—Ä–∞–≤–ª—è–µ—à—å —Å—Ü–µ–Ω–æ–π –∫–Ω–æ–ø–∫–∞–º–∏.
          –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –æ—Ç–∫—Ä—ã—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.
        </p>

        <div class="controls">
          <button class="btn btn-main" id="btnOpen">–û—Ç–∫—Ä—ã—Ç—å –ø–∏—Å—å–º–æ</button>
          <button class="btn btn-alt" id="btnFireworks">–°–¥–µ–ª–∞—Ç—å —Å–∞–ª—é—Ç</button>
          <button class="btn btn-ghost" id="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div class="legend">
          <p><strong>–û—Ç–∫—Ä—ã—Ç—å –ø–∏—Å—å–º–æ</strong> –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π –≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç.</p>
          <p><strong>–°–¥–µ–ª–∞—Ç—å —Å–∞–ª—é—Ç</strong> –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç, –¥–∞–∂–µ –±–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∏—è.</p>
        </div>

        <article class="letter" id="letter">
          <span class="typing" id="typing"></span><span class="cursor" id="cursor"></span>
        </article>
      </div>

      <div class="panel panel-visual">
        <div class="stage" id="stage" aria-hidden="true">
          <div class="ring ring-a"></div>
          <div class="ring ring-b"></div>
          <div class="glow"></div>
          <div class="heart" id="heart"></div>
        </div>
        <p class="from">–û—Ç: <span id="fromName">...</span></p>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const SETTINGS = {
      toName: "–ñ–∞–Ω—ã–º",
      fromName: "–ù—É—Ä–∏—Å",
      typeSpeed: 18,
      message: [
        "–ñ–∞–Ω—ã–º.",
        "–†—è–¥–æ–º —Å —Ç–æ–±–æ–π –≤—Å–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ø–æ–∫–æ–π–Ω–µ–µ –∏ —Ç–µ–ø–ª–µ–µ.",
        "–¢—ã —É–º–µ–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π, –∫–æ–≥–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–µ–≤–æ–∂–Ω–æ,",
        "–∏ —É–º–µ–µ—à—å —Ä–∞—Å—Å–º–µ—à–∏—Ç—å –∏–º–µ–Ω–Ω–æ –≤ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —ç—Ç–æ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ.",
        "",
        "–°–ø–∞—Å–∏–±–æ —Ç–µ–±–µ –∑–∞ —Ç–≤–æ—é –¥–æ–±—Ä–æ—Ç—É, –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –º–µ–ª–æ—á–∞–º,",
        "–∑–∞ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∑–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –∑–∞ —Ç–æ, –∫–∞–∫ —Ç—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ –ª—é–¥—è–º.",
        "–Ø —ç—Ç–æ –ø—Ä–∞–≤–¥–∞ –∑–∞–º–µ—á–∞—é –∏ –æ—á–µ–Ω—å —Ü–µ–Ω—é.",
        "",
        "–•–æ—á—É, —á—Ç–æ–±—ã —É —Ç–µ–±—è —á–∞—â–µ –±—ã–ª–∏ –ª–µ–≥–∫–∏–µ –∏ —Å—á–∞—Å—Ç–ª–∏–≤—ã–µ –¥–Ω–∏,",
        "—á—Ç–æ–±—ã –º–µ—á—Ç—ã –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å, –∞ —Å–±—ã–≤–∞–ª–∏—Å—å —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.",
        "–ß—Ç–æ–±—ã —Ä—è–¥–æ–º –±—ã–ª–∏ –ª—é–¥–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —Ç–µ–±–µ —Å–ø–æ–∫–æ–π–Ω–æ –∏ —Ö–æ—Ä–æ—à–æ.",
        "",
        "–ò –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –±—É–¥–µ—Ç —Ç—è–∂–µ–ª—ã–π –¥–µ–Ω—å, –ø—Ä–æ—Å—Ç–æ –ø–æ–º–Ω–∏:",
        "—Ç—ã –æ—á–µ–Ω—å —Ü–µ–Ω–Ω–∞—è, —Å–∏–ª—å–Ω–∞—è –∏ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –∫—Ä–∞—Å–∏–≤–∞—è –¥—É—à–æ–π.",
        "",
        "–ü—É—Å—Ç—å –≤ —Å–µ—Ä–¥—Ü–µ –±—É–¥–µ—Ç –º–Ω–æ–≥–æ —Ç–µ–ø–ª–∞, —É–ª—ã–±–æ–∫ –∏ –ª—é–±–≤–∏. ‚ù§Ô∏è"
      ].join("\n")
    };

    const SAVE_KEY = "valentine_show_state_v2";

    const elCard = document.getElementById("card");
    const elStage = document.getElementById("stage");
    const elHeart = document.getElementById("heart");
    const elLetter = document.getElementById("letter");
    const elTyping = document.getElementById("typing");
    const elCursor = document.getElementById("cursor");
    const elToName = document.getElementById("toName");
    const elFromName = document.getElementById("fromName");
    const elToast = document.getElementById("toast");

    const btnOpen = document.getElementById("btnOpen");
    const btnFireworks = document.getElementById("btnFireworks");
    const btnReset = document.getElementById("btnReset");

    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d");

    let opened = false;
    let typingToken = 0;
    let toastTimer = null;
    let dpr = Math.min(2, window.devicePixelRatio || 1);
    let width = 0;
    let height = 0;
    const particles = [];

    const isCoarsePointer = window.matchMedia("(pointer: coarse)").matches;

    init();

    function init(){
      elToName.textContent = SETTINGS.toName;
      elFromName.textContent = SETTINGS.fromName;
      resizeCanvas();
      loadState();
      bindEvents();
      requestAnimationFrame(loop);
    }

    function bindEvents(){
      btnOpen.addEventListener("click", openLetter);
      btnFireworks.addEventListener("click", () => fireworksShow(4, true));
      btnReset.addEventListener("click", resetScene);
      window.addEventListener("resize", resizeCanvas);
      window.addEventListener("beforeunload", saveState);

      if(!isCoarsePointer){
        let lastMove = 0;
        elCard.addEventListener("pointermove", (e) => {
          const now = performance.now();
          if(now - lastMove < 16) return;
          lastMove = now;

          const rect = elCard.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;
          const rx = (y - 0.5) * -6;
          const ry = (x - 0.5) * 8;
          elCard.style.transform = "rotateX(" + rx + "deg) rotateY(" + ry + "deg)";
        });

        elCard.addEventListener("pointerleave", () => {
          elCard.style.transform = "rotateX(0deg) rotateY(0deg)";
        });
      }
    }

    async function openLetter(){
      typingToken += 1;

      if(!opened){
        opened = true;
        elLetter.classList.add("show");
        btnOpen.textContent = "–û—Ç–∫—Ä—ã—Ç—å –∑–∞–Ω–æ–≤–æ";
      }

      pulseVisual();
      megaBurstFromHeart(170);
      await sleep(180);
      await fireworksShow(3, false);
      await typeWriter(SETTINGS.message, SETTINGS.typeSpeed);
      saveState();
      toast("–ü–∏—Å—å–º–æ –æ—Ç–∫—Ä—ã—Ç–æ");
    }

    function resetScene(){
      typingToken += 1;
      opened = false;
      elLetter.classList.remove("show");
      elTyping.textContent = "";
      elCursor.style.display = "inline-block";
      btnOpen.textContent = "–û—Ç–∫—Ä—ã—Ç—å –ø–∏—Å—å–º–æ";
      elStage.classList.remove("wow");
      elHeart.classList.remove("boom");
      particles.length = 0;
      saveState();
      toast("–°—Ü–µ–Ω–∞ —Å–±—Ä–æ—à–µ–Ω–∞");
    }

    async function typeWriter(text, speed){
      const token = typingToken;
      elTyping.textContent = "";
      elCursor.style.display = "inline-block";

      for(let i=0;i<text.length;i++){
        if(token !== typingToken) return;
        elTyping.textContent += text[i];
        if(navigator.vibrate && isCoarsePointer && i % 26 === 0){
          navigator.vibrate(5);
        }
        await sleep(speed);
      }

      if(token === typingToken){
        elCursor.style.display = "none";
      }
    }

    async function fireworksShow(rounds, withToast){
      if(withToast){
        toast("–°–∞–ª—é—Ç –∑–∞–ø—É—â–µ–Ω");
      }

      for(let i=0;i<rounds;i++){
        const x = rand(width * 0.2, width * 0.8);
        const y = rand(height * 0.16, height * 0.42);
        launchFirework(x, y, 80 + Math.floor(Math.random() * 30));
        await sleep(170);
      }
    }

    function pulseVisual(){
      elStage.classList.remove("wow");
      elHeart.classList.remove("boom");
      void elStage.offsetWidth;
      elStage.classList.add("wow");
      elHeart.classList.add("boom");

      setTimeout(() => {
        elStage.classList.remove("wow");
        elHeart.classList.remove("boom");
      }, 760);
    }

    function launchFirework(x, y, count){
      for(let i=0;i<count;i++){
        const angle = Math.random() * Math.PI * 2;
        const speed = rand(1.5, 6.6) * dpr;
        const hue = rand(340, 390);

        particles.push({
          x, y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed - 1.6 * dpr,
          g: 0.12 * dpr,
          life: 62 + Math.random() * 52,
          size: rand(1.4, 4.4) * dpr,
          shape: Math.random() > 0.7 ? "heart" : (Math.random() > 0.55 ? "star" : "dot"),
          colorA: "hsla(" + hue + ", 95%, 68%, ",
          colorB: "hsla(" + (hue - 20) + ", 100%, 88%, ",
          rot: Math.random() * Math.PI,
          vr: (Math.random() - 0.5) * 0.22
        });
      }
    }

    function megaBurstFromHeart(count){
      const rect = elHeart.getBoundingClientRect();
      const cx = (rect.left + rect.width / 2) * dpr;
      const cy = (rect.top + rect.height / 2) * dpr;
      launchFirework(cx, cy, count);
    }

    function loop(){
      ctx.clearRect(0, 0, width, height);

      if(opened && Math.random() < 0.08){
        const rect = elStage.getBoundingClientRect();
        const x = (rect.left + rect.width * Math.random()) * dpr;
        const y = (rect.top + rect.height * rand(0.18, 0.84)) * dpr;
        particles.push({
          x, y,
          vx: rand(-0.6, 0.6) * dpr,
          vy: rand(-2.1, -0.7) * dpr,
          g: 0.04 * dpr,
          life: 46 + Math.random() * 22,
          size: rand(1.2, 2.5) * dpr,
          shape: "heart",
          colorA: "hsla(350, 94%, 70%, ",
          colorB: "hsla(38, 100%, 84%, ",
          rot: Math.random() * Math.PI,
          vr: (Math.random() - 0.5) * 0.18
        });
      }

      for(let i=particles.length - 1; i>=0; i--){
        const p = particles[i];
        p.life -= 1;
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;

        const alpha = Math.max(0, Math.min(1, p.life / 84));
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.globalAlpha = alpha;

        if(p.shape === "heart"){
          ctx.fillStyle = p.colorA + "0.72)";
          drawMiniHeart(ctx, 0, 0, p.size * 1.5);
          ctx.fillStyle = p.colorB + "0.38)";
          drawMiniHeart(ctx, 0, 0, p.size * 0.95);
        }else if(p.shape === "star"){
          ctx.fillStyle = p.colorA + "0.8)";
          drawStar(ctx, 0, 0, p.size * 1.7);
        }else{
          ctx.fillStyle = p.colorA + "0.7)";
          ctx.fillRect(-p.size, -p.size, p.size * 2, p.size * 2);
        }

        ctx.restore();

        if(
          p.life <= 0 ||
          p.x < -200 ||
          p.x > width + 200 ||
          p.y > height + 220
        ){
          particles.splice(i, 1);
        }
      }

      requestAnimationFrame(loop);
    }

    function drawMiniHeart(c, x, y, s){
      c.beginPath();
      c.moveTo(x, y + s * 0.32);
      c.bezierCurveTo(x - s * 0.92, y - s * 0.22, x - s * 0.34, y - s * 0.96, x, y - s * 0.42);
      c.bezierCurveTo(x + s * 0.34, y - s * 0.96, x + s * 0.92, y - s * 0.22, x, y + s * 0.32);
      c.closePath();
      c.fill();
    }

    function drawStar(c, x, y, r){
      c.beginPath();
      for(let i=0; i<5; i++){
        const a = (Math.PI * 2 * i) / 5 - Math.PI / 2;
        const ox = x + Math.cos(a) * r;
        const oy = y + Math.sin(a) * r;
        const ia = a + Math.PI / 5;
        const ix = x + Math.cos(ia) * r * 0.42;
        const iy = y + Math.sin(ia) * r * 0.42;
        if(i === 0) c.moveTo(ox, oy); else c.lineTo(ox, oy);
        c.lineTo(ix, iy);
      }
      c.closePath();
      c.fill();
    }

    function resizeCanvas(){
      dpr = Math.min(2, window.devicePixelRatio || 1);
      width = canvas.width = Math.floor(window.innerWidth * dpr);
      height = canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
    }

    function saveState(){
      try{
        const data = {
          opened,
          typed: elTyping.textContent
        };
        sessionStorage.setItem(SAVE_KEY, JSON.stringify(data));
      }catch{}
    }

    function loadState(){
      try{
        const raw = sessionStorage.getItem(SAVE_KEY);
        if(!raw) return;

        const data = JSON.parse(raw);
        if(!data || !data.opened) return;

        opened = true;
        elLetter.classList.add("show");
        btnOpen.textContent = "–û—Ç–∫—Ä—ã—Ç—å –∑–∞–Ω–æ–≤–æ";
        elTyping.textContent = (typeof data.typed === "string" && data.typed.length > 0)
          ? data.typed
          : SETTINGS.message;
        elCursor.style.display = "none";
      }catch{}
    }

    function toast(text){
      clearTimeout(toastTimer);
      elToast.textContent = text;
      elToast.classList.add("show");
      toastTimer = setTimeout(() => {
        elToast.classList.remove("show");
      }, 1300);
    }

    function rand(a, b){
      return a + Math.random() * (b - a);
    }

    function sleep(ms){
      return new Promise((resolve) => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
